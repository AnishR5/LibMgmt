generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model notification_logs {
  id              BigInt         @id @default(autoincrement())
  org_id          BigInt?
  subscription_id BigInt?
  channel         String
  to_address      String
  type            String
  status          String
  provider_msg_id String?
  error_message   String?
  payload         Json?
  created_at      DateTime       @default(now()) @db.Timestamptz(6)
  sent_at         DateTime?      @db.Timestamptz(6)
  orgs            orgs?          @relation(fields: [org_id], references: [id], onUpdate: NoAction)
  subscriptions   subscriptions? @relation(fields: [subscription_id], references: [id], onUpdate: NoAction)
}

model orgs {
  id                  BigInt              @id @default(autoincrement())
  name                String
  timezone            String              @default("Asia/Kolkata")
  contact_phone       String?
  contact_email       String?
  total_tables        Int                 @default(0)
  default_monthly_fee BigInt              @default(0)
  created_at          DateTime            @default(now()) @db.Timestamptz(6)
  updated_at          DateTime            @default(now()) @db.Timestamptz(6)
  notification_logs   notification_logs[]
  payments            payments[]
  subscribers         subscribers[]
  subscriptions       subscriptions[]
}

model payments {
  id              BigInt         @id @default(autoincrement())
  org_id          BigInt
  subscription_id BigInt?
  amount          BigInt
  currency        String         @default("INR")
  method          String?
  txn_id          String?
  paid_at         DateTime       @default(now()) @db.Timestamptz(6)
  created_at      DateTime       @default(now()) @db.Timestamptz(6)
  orgs            orgs           @relation(fields: [org_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  subscriptions   subscriptions? @relation(fields: [subscription_id], references: [id], onUpdate: NoAction)

  @@index([subscription_id], map: "idx_payments_subscription")
}

model subscribers {
  id            BigInt          @id @default(autoincrement())
  org_id        BigInt
  phone         String
  name          String?
  email         String?
  created_at    DateTime        @default(now()) @db.Timestamptz(6)
  updated_at    DateTime        @default(now()) @db.Timestamptz(6)
  orgs          orgs            @relation(fields: [org_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  subscriptions subscriptions[]

  @@unique([org_id, phone])
}

model subscriptions {
  id                BigInt              @id @default(autoincrement())
  org_id            BigInt
  subscriber_id     BigInt
  start_date        DateTime            @db.Timestamptz(6)
  end_date          DateTime            @db.Timestamptz(6)
  status            String              @default("active")
  auto_renew        Boolean             @default(false)
  created_at        DateTime            @default(now()) @db.Timestamptz(6)
  updated_at        DateTime            @default(now()) @db.Timestamptz(6)
  notification_logs notification_logs[]
  payments          payments[]
  orgs              orgs                @relation(fields: [org_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  subscribers       subscribers         @relation(fields: [subscriber_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([org_id, end_date], map: "idx_subscriptions_org_enddate")
  @@index([org_id, status], map: "idx_subscriptions_org_status")
}
